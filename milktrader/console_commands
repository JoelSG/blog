# R 2.14.0
# quantmod 0.3-17
# gdata 2.8.2
# source: http://www.eia.gov/dnav/ng/ng_pri_fut_s1_d.htm
# please send feedback to milktrader@gmail.com 

# require pacakges

require(gdata)
require(quantmod)

#import data and subset

gas             <- read.xls("~/Downloads/NatGas.xlsx")
G               <- xts(gas[,-1], order.by=as.POSIXct(paste(gas[,1]), format="%Y-%m-%d"))
names(G)        <- 'close'
G$RET           <- dailyReturn(G)
G$ret           <- dailyReturn(Cl(G), type="log")
G$fivedayreturn <- exp(G$ret + lag(G$ret) + lag(G$ret, k=2) + lag(G$ret, k=3) + lag(G$ret, k=4))  -1  
G$nextday       <- lag(G$RET, k=-1)
g               <- G[G$fivedayreturn < -.15]
gg              <- (na.omit(g))

# sanity test

# 2009-11-16 next day was 0
# firsttest <- G['2009-11'] 
# (290 -290)/290

# 2007-02-22 next day was 0.0093
# secondtest <- G['2007-02']
# (756-749)/749

# plotting details

natty           <- 2.26
gg$plot         <- natty + (natty* gg$nextday) 
gen             <- density(gg$plot)
max             <- 12   
min             <- 1
more            <- natty
less            <- more
x1              <- min(which(gen$x >= more))
x2              <- max(which(gen$x <  max))
x3              <- min(which(gen$x >= min))
x4              <- max(which(gen$x <  less))

# plot and save

png("path/to/file.png")
plot(gen, xlab="Jan 23, 2012", ylab="", main="", yaxt="n")
with(gen, polygon(x=c(x[c(x3,x3:x4,x4)]), y= c(0, y[x3:x4], 0), col="hotpink4"))
with(gen, polygon(x=c(x[c(x1,x1:x2,x2)]), y= c(0, y[x1:x2], 0), col="hotpink"))
text(2.5, .1, "38", cex=.7)
text(2.1, .1, "39", cex=.7)
dev.off()


#### DATA ####

# 2001-01-16 -0.033333333
# 2001-01-17 -0.094508301
# 2001-01-18  0.071932299
# 2001-01-30 -0.020168067
# 2001-01-31  0.010291595
# 2001-02-01  0.142614601
# 2001-06-29 -0.010135135
# 2001-07-02  0.023890785
# 2001-08-27 -0.044776119
# 2001-08-28 -0.039062500
# 2001-08-29  0.008130081
# 2001-08-31  0.027522936
# 2001-09-04  0.044642857
# 2001-09-21 -0.034146341
# 2001-09-24 -0.015151515
# 2001-11-12 -0.016260163
# 2001-11-15 -0.170731707
# 2001-11-16  0.282352941
# 2001-11-21  0.000000000
# 2001-12-05 -0.010810811
# 2001-12-06  0.153005464
# 2002-01-03 -0.056224900
# 2003-03-03 -0.102064220
# 2003-03-04 -0.019157088
# 2003-03-05 -0.023437500
# 2003-03-07 -0.071140940
# 2003-03-10 -0.098265896
# 2003-03-11 -0.059294872
# 2003-03-12 -0.051107325
# 2003-03-13 -0.075403950
# 2003-03-14  0.029126214
# 2003-03-17 -0.028301887
# 2003-03-18  0.007766990
# 2003-10-31  0.062972292
# 2003-12-24  0.000000000
# 2003-12-26 -0.001821494
# 2003-12-29  0.091240876
# 2004-01-14  0.013745704
# 2004-01-16  0.107078040
# 2004-11-09  0.000000000
# 2004-11-11  0.028380634
# 2004-11-22  0.078028747
# 2004-11-24  0.000000000
# 2005-01-03  0.001798561
# 2005-01-04  0.028725314
# 2005-11-01 -0.003696858
# 2005-11-02  0.004638219
# 2005-11-03 -0.136657433
# 2005-11-04 -0.050267380
# 2005-11-07  0.061936937
# 2005-12-23 -0.099823322
# 2005-12-27 -0.028459274
# 2005-12-28  0.014141414
# 2005-12-29 -0.059760956
# 2005-12-30  0.054025424
# 2006-08-07  0.019943020
# 2006-08-08  0.065642458
# 2006-08-31 -0.089983022
# 2006-09-01  0.024253731
# 2006-09-05  0.043715847
# 2006-09-29  0.114754098
# 2007-02-22  0.009345794
# 2007-08-22  0.000000000
# 2007-08-23 -0.017211704
# 2007-08-24 -0.063047285
# 2007-08-27  0.039252336
# 2009-05-26  0.023460411
# 2009-09-01 -0.042194093
# 2009-09-02 -0.096916300
# 2009-09-03 -0.063414634
# 2009-09-04  0.302083333
# 2009-10-01 -0.131034483
# 2009-10-02  0.214285714
# 2009-10-29  0.012195122
# 2009-11-11 -0.108635097
# 2009-11-12 -0.212500000
# 2009-11-13  0.150793651
# 2009-11-16  0.000000000
# 2009-11-17  0.279310345
# 2011-11-23  0.000000000
# 2011-11-25  0.218750000
# 2012-01-18 -0.052208835
# 2012-01-19 -0.042372881
